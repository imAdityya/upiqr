<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
<title>UPI Payment QR</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<style>
  *{box-sizing:border-box;margin:0;padding:0}
  body{
    font-family: 'Segoe UI', sans-serif;
    background: linear-gradient(135deg, #1e3a8a, #0f172a);
    color:#fff; display:flex; justify-content:center; align-items:center;
    min-height:100vh;
  }
  .screen{
    width:100%; max-width:420px; padding:20px;
    display:flex; flex-direction:column; align-items:center;
    transition: opacity 0.4s ease, transform 0.4s ease;
  }
  .screen.transition-exit {
    opacity: 0;
    transform: translateY(20px);
  }
  .screen.transition-enter {
    opacity: 1;
    transform: translateY(0);
  }
  .card{
    background:rgba(255,255,255,0.08); padding:20px;
    border-radius:16px; backdrop-filter: blur(8px);
    width:100%; box-shadow: 0 8px 20px rgba(0,0,0,0.3);
  }
  .amount-display{
    background:rgba(0,0,0,0.3); padding:20px; font-size:2rem;
    text-align:center; border-radius:12px;
    margin-bottom:20px; letter-spacing:2px; font-weight:bold;
  }
  .keypad{
    display:grid; grid-template-columns:repeat(3,1fr); gap:12px;
    margin-top:10px;
  }
  .key{
    background:rgba(255,255,255,0.12); padding:20px; font-size:1.6rem;
    border-radius:12px; text-align:center; cursor:pointer;
    user-select:none; transition:0.2s;
  }
  .key:active{ background:rgba(255,255,255,0.25); }
  .generate-btn{
    margin-top:15px; background:#16a34a; padding:15px; font-size:1.2rem;
    border:none; border-radius:12px; color:white; cursor:pointer; width:100%;
    font-weight:bold;
  }
  .generate-btn:active{ background:#15803d; }
  .hidden{ display:none; }
  .qr-section{
    text-align:center;
  }
  #qrFrame{
    background:white; padding:20px; border-radius:16px;
    display:inline-block; box-shadow:0 6px 20px rgba(0,0,0,0.4);
    margin-top:15px;
  }
  .link-box{
    background:rgba(255,255,255,0.12);
    padding:10px 15px;
    border-radius:8px;
    margin-top:15px;
    font-size:1rem;
    font-weight:bold;
    text-align:center;
    letter-spacing:0.5px;
    word-break:keep-all;
    cursor: pointer;
    overflow-wrap: break-word;
  }
  .btn-row{
    display:flex; gap:10px; margin-top:15px; flex-wrap:wrap; justify-content:center;
  }
  .small-btn{
    padding:10px 14px; border:none; border-radius:8px; cursor:pointer; font-size:0.9rem;
    font-weight:bold;
  }
  .copy{background:#0ea5e9;color:white;}
  .open{background:#facc15;color:black;}
  .download{background:#f97316;color:white;}
  .back-btn{
    margin-top:20px; background:#64748b; color:white; border:none;
    padding:10px 16px; border-radius:8px; cursor:pointer;
  }
  .amount-label{
    font-size:1.2rem; margin-bottom:10px; color:#94a3b8;
  }
  .upi-selection-container {
      margin-bottom: 20px;
      width: 100%;
  }
  .upi-selection-container label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
  }
  .upi-selection-container select {
      width: 100%;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid #4a5568;
      background: #2d3748;
      color: white;
      font-size: 1rem;
      appearance: none;
  }
  .manage-btn {
      background-color: #3b82f6;
      color: white;
      padding: 10px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 1rem;
      width: 100%;
      margin-top: 10px;
  }
  .manage-btn:active { background-color: #2563eb; }
  .add-upi-form input {
      width: 100%;
      padding: 10px;
      margin-bottom: 10px;
      border-radius: 8px;
      border: 1px solid #4a5568;
      background: #2d3748;
      color: white;
      font-size: 1rem;
  }
  .form-actions { display: flex; gap: 10px; }
  .form-actions button { flex: 1; }
  #add-upi-screen .card { display: flex; flex-direction: column; gap: 15px; }
</style>
</head>
<body>

<div class="screen transition-exit" id="add-upi-screen">
    <div class="card">
        <h2>Add UPI Details</h2>
        <p style="text-align: center;">Please add at least one UPI ID to get started.</p>
        <div class="add-upi-form">
            <input type="text" id="initial-upi-id" placeholder="Enter UPI ID (e.g., user@bank)">
            <input type="text" id="initial-upi-name" placeholder="Enter Name (e.g., John Doe)">
            <button class="generate-btn" id="initial-save-btn">Save and Continue</button>
        </div>
    </div>
</div>

<div class="screen transition-exit hidden" id="main-app-screen">
  <div class="card">
    <div class="upi-selection-container">
        <label for="upi-select">Receive Money to:</label>
        <select id="upi-select"></select>
        <button class="manage-btn" id="manage-upi-btn">Manage UPI IDs</button>
    </div>
    <div class="amount-display" id="display">₹ 0.00</div>
    <div class="keypad">
      <div class="key">1</div>
      <div class="key">2</div>
      <div class="key">3</div>
      <div class="key">4</div>
      <div class="key">5</div>
      <div class="key">6</div>
      <div class="key">7</div>
      <div class="key">8</div>
      <div class="key">9</div>
      <div class="key">.</div>
      <div class="key">0</div>
      <div class="key" id="back">⌫</div>
    </div>
    <button class="generate-btn" id="generate">Generate QR</button>
  </div>
</div>

<div class="screen transition-exit hidden" id="qr-screen">
  <div class="card qr-section">
    <h2>Scan to Pay</h2>
    <div class="amount-label" id="qrAmount"></div>
    <div id="qrFrame"><div id="qrcode"></div></div>
    <div class="link-box" id="upiLink"></div>
    <div class="btn-row">
      <button class="small-btn copy" id="copyBtn">Copy Link</button>
      <button class="small-btn open" id="openBtn">Open UPI</button>
      <button class="small-btn download" id="downloadBtn">Download QR</button>
    </div>
    <button class="back-btn" id="backBtn">← Back</button>
  </div>
</div>

<div class="screen transition-exit hidden" id="manage-upi-screen">
    <div class="card">
        <h2>Manage UPI IDs</h2>
        <div id="upi-list"></div>
        <hr style="margin: 20px 0; border: none; border-top: 1px solid #4a5568;">
        <h3>Add New UPI ID</h3>
        <div class="add-upi-form">
            <input type="text" id="new-upi-id" placeholder="Enter UPI ID (e.g., user@bank)">
            <input type="text" id="new-upi-name" placeholder="Enter Name (e.g., John Doe)">
            <div class="form-actions">
                <button class="generate-btn" id="save-upi-btn">Add UPI ID</button>
                <button class="back-btn" id="manage-back-btn">Back</button>
            </div>
        </div>
    </div>
</div>

<script>
const CU = "INR";
const MAX_AMOUNT = 100000;
let amount = "";
let lastGeneratedURL = "";
let lastGeneratedUpiId = "";
let qrCodeInstance = null;
let upiList = [];

const display = document.getElementById("display");
const keys = document.querySelectorAll(".key");
const generateBtn = document.getElementById("generate");
const initialUpiIdInput = document.getElementById("initial-upi-id");
const initialUpiNameInput = document.getElementById("initial-upi-name");
const initialSaveBtn = document.getElementById("initial-save-btn");
const addUpiScreen = document.getElementById("add-upi-screen");
const mainAppScreen = document.getElementById("main-app-screen");
const qrScreen = document.getElementById("qr-screen");
const upiLinkBox = document.getElementById("upiLink");
const copyBtn = document.getElementById("copyBtn");
const openBtn = document.getElementById("openBtn");
const downloadBtn = document.getElementById("downloadBtn");
const backBtn = document.getElementById("backBtn");
const qrAmount = document.getElementById("qrAmount");
const qrDiv = document.getElementById("qrcode");
const upiSelect = document.getElementById("upi-select");
const manageUpiBtn = document.getElementById("manage-upi-btn");
const manageUpiScreen = document.getElementById("manage-upi-screen");
const upiListDiv = document.getElementById("upi-list");
const newUpiIdInput = document.getElementById("new-upi-id");
const newUpiNameInput = document.getElementById("new-upi-name");
const saveUpiBtn = document.getElementById("save-upi-btn");
const manageBackBtn = document.getElementById("manage-back-btn");

function getUpiCookie() {
    const name = "upi_ids=";
    const decodedCookie = decodeURIComponent(document.cookie);
    const ca = decodedCookie.split(';');
    for(let i = 0; i < ca.length; i++) {
        let c = ca[i].trim();
        if (c.indexOf(name) === 0) {
            try { return JSON.parse(c.substring(name.length)); }
            catch { return []; }
        }
    }
    return [];
}
function setUpiCookie(upiData) {
    const d = new Date();
    d.setTime(d.getTime() + (365 * 24 * 60 * 60 * 1000));
    document.cookie = "upi_ids=" + JSON.stringify(upiData) + ";expires=" + d.toUTCString() + ";path=/";
}
function populateUpiSelect() {
    upiSelect.innerHTML = '';
    upiList.forEach((upi, index) => {
        const option = document.createElement('option');
        option.value = index;
        option.textContent = `${upi.pn} (${upi.pa})`;
        upiSelect.appendChild(option);
    });
}
function renderUpiList() {
    upiListDiv.innerHTML = '';
    upiList.forEach((upi, index) => {
        const item = document.createElement('div');
        item.style.marginBottom = "10px";
        item.style.padding = "10px";
        item.style.backgroundColor = "rgba(255,255,255,0.1)";
        item.style.borderRadius = "8px";
        item.innerHTML = `<div><strong>Name:</strong> ${upi.pn}</div>
                          <div><strong>UPI ID:</strong> ${upi.pa}</div>
                          <button style="background: #ef4444; color: white; padding: 5px 10px; border: none; border-radius: 4px; cursor: pointer; margin-top: 5px;" onclick="deleteUpiId(${index})">Delete</button>`;
        upiListDiv.appendChild(item);
    });
}
function saveUpiList() { setUpiCookie(upiList); populateUpiSelect(); renderUpiList(); }
function deleteUpiId(index) {
    if (upiList.length <= 1) { alert("You must have at least one UPI ID."); return; }
    if (confirm("Delete this UPI ID?")) { upiList.splice(index, 1); saveUpiList(); }
}
function updateDisplay(){ display.textContent = "₹ " + ((parseFloat(amount)||0).toFixed(2)); }
function showScreen(screenToShow) {
    [addUpiScreen, mainAppScreen, qrScreen, manageUpiScreen].forEach(screen => {
        if (screen === screenToShow) {
            screen.classList.remove('hidden','transition-exit');
            screen.classList.add('transition-enter');
        } else {
            screen.classList.add('hidden','transition-exit');
            screen.classList.remove('transition-enter');
        }
    });
}

keys.forEach(key=>{
  key.addEventListener("click", ()=>{
    const val = key.textContent;
    if(val === "⌫"){
        amount = amount.slice(0, -1);
    } else {
        const parts = amount.split('.');
        const digitsBeforeDecimal = parts[0];
        if (val !== '.' && digitsBeforeDecimal.length >= 6) {
            alert("Maximum amount is ₹1,00,000.");
            return;
        }

        if(val === "." && amount.includes(".")) return;
        if(amount === "0" && val !== ".") amount = "";
        
        const newAmount = amount + val;
        if (parseFloat(newAmount) > MAX_AMOUNT) {
            alert("Maximum amount is ₹1,00,000.");
            return;
        }

        amount = newAmount;
    }
    updateDisplay();
  });
});

generateBtn.addEventListener("click", ()=>{
  const num = parseFloat(amount);
  if(isNaN(num) || num <= 0){ alert("Please enter a valid amount"); return; }
  const selectedUpi = upiList[upiSelect.value];
  if (!selectedUpi) { alert("Please select a valid UPI ID."); return; }
  const upiURL = `upi://pay?pa=${encodeURIComponent(selectedUpi.pa)}&pn=${encodeURIComponent(selectedUpi.pn)}&am=${num.toFixed(2)}&cu=${CU}`;
  lastGeneratedURL = upiURL;
  lastGeneratedUpiId = selectedUpi.pa;
  qrAmount.textContent = `Amount: ₹${num.toFixed(2)} to ${selectedUpi.pn}`;
  upiLinkBox.textContent = `UPI ID: ${selectedUpi.pa}`;
  qrDiv.innerHTML = "";
  qrCodeInstance = new QRCode(qrDiv, { text: upiURL, width: 200, height: 200, colorDark: "#000", colorLight: "#fff", correctLevel: QRCode.CorrectLevel.M });
  showScreen(qrScreen);
});

copyBtn.addEventListener("click", async ()=>{
  if(lastGeneratedURL){
    try { await navigator.clipboard.writeText(lastGeneratedURL); copyBtn.textContent = "Copied!"; setTimeout(()=>copyBtn.textContent = "Copy Link",2000); }
    catch { alert("Unable to copy"); }
  }
});
upiLinkBox.addEventListener("click", async ()=>{
  if(lastGeneratedUpiId){
    try { 
        await navigator.clipboard.writeText(lastGeneratedUpiId); 
        const originalText = upiLinkBox.textContent; 
        upiLinkBox.textContent = "Copied!"; 
        setTimeout(()=>upiLinkBox.textContent = originalText,2000); 
    }
    catch { alert("Unable to copy"); }
  }
});
openBtn.addEventListener("click", ()=>{ if(lastGeneratedURL) window.open(lastGeneratedURL, '_blank'); });

downloadBtn.addEventListener("click", ()=>{
    if(lastGeneratedURL){
        const qrCanvas = qrDiv.querySelector("canvas");
        if (qrCanvas) {
            const selectedUpi = upiList[upiSelect.value];
            createFormattedQRImage(qrCanvas, parseFloat(amount).toFixed(2), selectedUpi.pn, selectedUpi.pa);
        } else {
            alert("QR code is not ready. Please try again.");
        }
    }
});

function createFormattedQRImage(qrCanvas, amountValue, receiverName, upiId) {
    const canvas = document.createElement("canvas");
    const ctx = canvas.getContext("2d");
    canvas.width = 400;
    canvas.height = 600;
    ctx.fillStyle = "#1a1a1a";
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    ctx.fillStyle = "#ffffff";
    ctx.font = "bold 24px Arial";
    ctx.textAlign = "center";
    ctx.fillText("UPI PAYMENT", canvas.width / 2, 50);
    ctx.font = "bold 32px Arial";
    ctx.fillStyle = "#4CAF50";
    ctx.fillText(`₹ ${amountValue}`, canvas.width / 2, 90);
    ctx.font = "18px Arial";
    ctx.fillStyle = "#ffffff";
    ctx.fillText(receiverName, canvas.width / 2, 120);
    ctx.font = "bold 20px Arial";
    ctx.fillStyle = "#8B5CF6";
    ctx.fillText("ACCEPTED HERE", canvas.width / 2, 160);
    ctx.font = "16px Arial";
    ctx.fillStyle = "#cccccc";
    ctx.fillText("Scan & Pay Using Any UPI App", canvas.width / 2, 185);
    const qrBgSize = 220;
    const qrBgX = (canvas.width - qrBgSize) / 2;
    const qrBgY = 200;
    ctx.fillStyle = "#ffffff";
    ctx.fillRect(qrBgX, qrBgY, qrBgSize, qrBgSize);
    const qrSize = 180;
    const qrX = (canvas.width - qrSize) / 2;
    const qrY = qrBgY + 20;
    ctx.drawImage(qrCanvas, qrX, qrY, qrSize, qrSize);
    ctx.font = "14px Arial";
    ctx.fillStyle = "#cccccc";
    ctx.textAlign = "center";
    const upiText = `UPI ID: ${upiId}`;
    ctx.fillText(upiText, canvas.width / 2, 450);
    ctx.font = "12px Arial";
    ctx.fillStyle = "#999999";
    ctx.fillText("1. Open any UPI app (PhonePe, GPay, Paytm, etc.)", canvas.width / 2, 480);
    ctx.fillText("2. Scan this QR code", canvas.width / 2, 500);
    ctx.fillText("3. Enter your UPI PIN to complete payment", canvas.width / 2, 520);
    ctx.font = "10px Arial";
    ctx.fillStyle = "#666666";
    ctx.fillText("Powered by UPI", canvas.width / 2, 570);
    ctx.strokeStyle = "#333333";
    ctx.lineWidth = 2;
    ctx.strokeRect(1, 1, canvas.width - 2, canvas.height - 2);
    const link = document.createElement("a");
    link.href = canvas.toDataURL("image/png", 1.0);
    link.download = `UPI_Payment_QR_${amountValue}.png`;
    link.click();
}

backBtn.addEventListener("click", ()=>{ showScreen(mainAppScreen); });
manageUpiBtn.addEventListener("click", ()=>{ showScreen(manageUpiScreen); });
manageBackBtn.addEventListener("click", ()=>{ showScreen(mainAppScreen); });
saveUpiBtn.addEventListener("click", ()=>{
    const id = newUpiIdInput.value.trim(), name = newUpiNameInput.value.trim();
    const upiRegex = /^[a-zA-Z0-9.\-_]{2,256}@[a-zA-Z]{2,64}$/;
    if (!id || !name) return alert("Please enter both UPI ID and Name.");
    if (!upiRegex.test(id)) return alert("Invalid UPI ID format");
    upiList.push({ pa: id, pn: name }); saveUpiList(); newUpiIdInput.value=""; newUpiNameInput.value=""; alert("UPI ID added successfully!"); showScreen(manageUpiScreen);
});
initialSaveBtn.addEventListener("click", ()=>{
    const id = initialUpiIdInput.value.trim(), name = initialUpiNameInput.value.trim();
    const upiRegex = /^[a-zA-Z0-9.\-_]{2,256}@[a-zA-Z]{2,64}$/;
    if (!id || !name) return alert("Please enter both UPI ID and Name.");
    if (!upiRegex.test(id)) return alert("Invalid UPI ID format");
    upiList.push({ pa: id, pn: name }); saveUpiList(); showScreen(mainAppScreen);
});

document.addEventListener('DOMContentLoaded', () => {
    upiList = getUpiCookie();
    if (upiList.length === 0) showScreen(addUpiScreen);
    else { populateUpiSelect(); renderUpiList(); updateDisplay(); showScreen(mainAppScreen); }
});
</script>
</body>
</html>